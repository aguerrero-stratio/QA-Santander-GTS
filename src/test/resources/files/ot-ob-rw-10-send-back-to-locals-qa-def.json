{"id":"42202ef4-9cb9-47ab-92ca-7b3c1d045c3f","name":"ot-ob-rw-10-send-back-to-locals-qa-def","description":"Send the errors back to local banks.","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"preExecutionSqlSentences":[],"postExecutionSqlSentences":[],"addAllUploadedPlugins":true,"mesosConstraint":"spark:true","mesosConstraintOperator":"LIKE","parametersLists":["Environment"],"parametersUsed":["COUNTRY","DATE","Environment.POSTGRE_ASINC_MS_ONBOARDING","Global.SFTP_HOST","Global.SFTP_PASS","Global.SFTP_USER","Global.SPARK_CORES_MAX","Global.SPARK_DRIVER_CORES","Global.SPARK_DRIVER_JAVA_OPTIONS","Global.SPARK_DRIVER_MEMORY","Global.SPARK_EXECUTOR_CORES","Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS","Global.SPARK_EXECUTOR_MEMORY","Global.SPARK_LOCALITY_WAIT","Global.SPARK_LOCAL_PATH","Global.SPARK_MEMORY_FRACTION","Global.SPARK_TASK_MAX_FAILURES"],"udfsToRegister":[],"udafsToRegister":[],"mesosRole":"","marathonDeploymentSettings":{"gracePeriodSeconds":"240","intervalSeconds":"20","timeoutSeconds":"20","maxConsecutiveFailures":"3","forcePullImage":true,"privileged":false,"userEnvVariables":[],"userLabels":[]},"enableQualityRules":true},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"mesos://zk://master.mesos:2181/mesos","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{Global.SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"{{{Global.SPARK_CORES_MAX}}}","executorMemory":"{{{Global.SPARK_EXECUTOR_MEMORY}}}","executorCores":"{{{Global.SPARK_EXECUTOR_CORES}}}","driverCores":"{{{Global.SPARK_DRIVER_CORES}}}","driverMemory":"{{{Global.SPARK_DRIVER_MEMORY}}}","mesosExtraCores":"","localityWait":"{{{Global.SPARK_LOCALITY_WAIT}}}","taskMaxFailures":"{{{Global.SPARK_TASK_MAX_FAILURES}}}","sparkMemoryFraction":"{{{Global.SPARK_MEMORY_FRACTION}}}","sparkParallelism":""},"sparkHistoryServerConf":{"enableHistoryServerMonitoring":false,"sparkHistoryServerEventLogRotateEnable":false,"sparkHistoryServerEventLogRotateNum":"9","sparkHistoryServerEventLogRotateSize":"512"},"userSparkConf":[],"coarse":true,"sparkUser":"","sparkLocalDir":"{{{Global.SPARK_LOCAL_PATH}}}","sparkKryoSerialization":false,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"out_SFTP_jsonKOs","stepType":"Output","className":"SFTPOutputStep","classPrettyName":"SFTP","arity":["NullaryToNullary","NaryToNullary"],"description":"Send back JSONs with KOs to local banks.","uiConfiguration":{"position":{"x":3296.2756129842264,"y":6.335315620994379}},"configuration":{"path":"/gts/onetrade/Onboarding/{{{COUNTRY}}}/OUT/","errorSink":false,"host":"{{{Global.SFTP_HOST}}}","tlsEnabled":false,"fileType":"json","port":"22","sftpServerUsername":"{{{Global.SFTP_USER}}}","errorTableName":"","saveOptions":"[]","password":"{{{Global.SFTP_PASS}}}"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"Json_OUT","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Creamos el JSON a enviar a GTS","uiConfiguration":{"position":{"x":2254.5100384834736,"y":-111.17565829520015}},"configuration":{"sql":"select collect_list(struct(\n*\n)) AS customer\nfrom Jo_OUT","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Rep_OUT","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":2521.18837112314,"y":-107.18558489687086}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Append","outputStepName":"out_SFTP_jsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_OUT","discardTableName":"","extraOptions":{"saveMode":"Append","partitionBy":""}},{"saveMode":"Overwrite","outputStepName":"out_JSON_JsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_OUT","discardTableName":"","extraOptions":{"partitionBy":"","partitionOverwriteEnabled":false,"partitionColumns":"","saveMode":"Overwrite","partitions":""}}],"errorTableName":""},{"name":"out_JSON_JsonKOs","stepType":"Output","className":"JsonOutputStep","classPrettyName":"Json","arity":["NullaryToNullary","NaryToNullary"],"description":"Save locally the sent JSON.","uiConfiguration":{"position":{"x":3285.934952655904,"y":297.1090583264409}},"configuration":{"path":"hdfs://gts-hdfs/gts/data/raw/unformatted/onetrade/onboarding/{{{COUNTRY}}}/OUT/","errorSink":false,"saveOptions":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[],"outputsWriter":[]},{"name":"in_JSON_onboarding","stepType":"Input","className":"JsonInputStep","classPrettyName":"Json","arity":["NullaryToNary"],"description":"Onboarding json to intake","uiConfiguration":{"position":{"x":931.41506268901,"y":-107.6677542899431}},"configuration":{"path":"/gts/data/raw/formatted/onetrade/onboarding/{{{COUNTRY}}}/original/onboarding{{{COUNTRY}}}{{{DATE}}}","inputOptions":"[]","debugOptions":"{\"fileUploaded\":\"hdfs:///user/gts-sparta/sparta/mockData/onboardingSPAIN20200121traceid.json\"}","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Expl_Identificadorlc","stepType":"Transformation","className":"ExplodeTransformStep","classPrettyName":"Explode","arity":["UnaryToNary"],"description":"Obtain a struct for every Identificadorlegalcustomer","uiConfiguration":{"position":{"x":1167.8856241117314,"y":-108.11025374221663}},"configuration":{"explodedField":"Identificador_legal_customer","inputSchemas":"[]","errorTableName":"","fieldsPreservationPolicy":"REPLACE","inputField":"customer"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Rep_QRKO","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":2514.1239932914796,"y":131.96689570392255}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Append","outputStepName":"out_SFTP_jsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_QRKO","discardTableName":"","extraOptions":{"saveMode":"Append","partitionBy":""}},{"saveMode":"Overwrite","outputStepName":"out_JSON_JsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_QRKO","discardTableName":"","extraOptions":{"partitionBy":"","partitionOverwriteEnabled":false,"partitionColumns":"","saveMode":"Overwrite","partitions":""}}],"errorTableName":""},{"name":"Sel_Data","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Selecciona todos los campos menos el companyGlobalId.","uiConfiguration":{"position":{"x":1437.3617026338402,"y":-106.73199376942509}},"configuration":{"sql":"SELECT\n\tIdentificador_legal_customer.traceId,\n\tIdentificador_legal_customer.accountsList,\n\tIdentificador_legal_customer.addressList,\n\tIdentificador_legal_customer.agent,\n\tIdentificador_legal_customer.cmc,\n\tIdentificador_legal_customer.companyAdditionalDetail,\n\tIdentificador_legal_customer.companyEndDate,\n\tIdentificador_legal_customer.companyId,\n\tIdentificador_legal_customer.companyName,\n\tIdentificador_legal_customer.companyStartDate,\n\tIdentificador_legal_customer.companyType,\n\tIdentificador_legal_customer.contactDataMOBI,\n\tIdentificador_legal_customer.contactDataMail,\n\tIdentificador_legal_customer.contactList,\n\tIdentificador_legal_customer.country,\n\tIdentificador_legal_customer.countryDocument,\n\tIdentificador_legal_customer.countryIncorporation,\n\tIdentificador_legal_customer.documentList,\n\tIdentificador_legal_customer.documentNumber,\n\tIdentificador_legal_customer.documentType,\n\tIdentificador_legal_customer.entity,\n\tIdentificador_legal_customer.firstName,\n\tIdentificador_legal_customer.internalRepresentUser,\n\tIdentificador_legal_customer.lastName,\n\tIdentificador_legal_customer.tradeName,\n\tIdentificador_legal_customer.typeDisposition\nFROM Expl_Identificadorlc\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Json_QRKO","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Creamos el JSON a enviar a GTS","uiConfiguration":{"position":{"x":2248.725187409255,"y":133.1340131067774}},"configuration":{"sql":"select collect_list(struct(\n\t*\n)) AS customer\nfrom Jo_QRKO","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Rep_KO_Detailed","stepType":"Transformation","className":"RepartitionTransformStep","classPrettyName":"Repartition","arity":[],"uiConfiguration":{"position":{"x":2522.3714072651046,"y":289.87610420948516}},"configuration":{"partitions":"1","columns":"[]","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[{"saveMode":"Overwrite","outputStepName":"out_JSON_JsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_KO_DETAILED","discardTableName":"","extraOptions":{"partitionBy":"","partitionOverwriteEnabled":false,"partitionColumns":"","saveMode":"Overwrite","partitions":""}},{"saveMode":"Append","outputStepName":"out_SFTP_jsonKOs","tableName":"onboarding{{{COUNTRY}}}{{{DATE}}}_KO_DETAILED","discardTableName":"","extraOptions":{"saveMode":"Append","partitionBy":""}}],"errorTableName":""},{"name":"Jo_OUT","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Every register with the status (OK or KO)","uiConfiguration":{"position":{"x":1973.7646062588433,"y":-108.49950327866205}},"configuration":{"sql":"SELECT DISTINCT\n\tFil_not_InProgress.status_id as statusId, \n\tSel_Data.*\nFROM Sel_Data\nINNER JOIN Fil_not_InProgress\nON Fil_not_InProgress.trace_id = Sel_Data.traceId\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Sel_QRKO","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Añade:\ngts_id,\ntrace_id,\ncountry,\ndate,\ntimeOfIntake (will be the time of Validation)","uiConfiguration":{"position":{"x":1630.8024137999923,"y":133.0509636431957}},"configuration":{"sql":"SELECT\n\tcollect_set(error_id) as errorsQA,\n\ttrace_id as traceId, \n\tstatus_id as statusId\nFROM Fil_not_InProgress\nWHERE main_error_id =\"QA\" and status_id = \"KO\"\ngroup by trace_id,status_id","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Jo_QRKO","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"All KO registers with QA as error, and an array with the errors.","uiConfiguration":{"position":{"x":1978.4595182921798,"y":133.05097890198476}},"configuration":{"sql":"SELECT DISTINCT\n\tSel_QRKO.*, \n\tSel_Data.*\nFROM Sel_Data\nINNER JOIN Sel_QRKO\nON Sel_QRKO.traceId = Sel_Data.traceId\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Sel_KO_Detailed","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Añade:\ngts_id,\ntrace_id,\ncountry,\ndate,\ntimeOfIntake (will be the time of Validation)","uiConfiguration":{"position":{"x":1641.4997099425705,"y":293.5080254107738}},"configuration":{"sql":"SELECT\n\tarray(struct(main_error_id as mainErrorId, NULL as mainErrorIdDescription, errors)) as mainErrors,\n\ttrace_id as traceId,\n\tstep_id as stepId,\n\tstatus_id as statusId\nFROM (\n  SELECT\n\t  trace_id, \n\t  collect_set(struct(error_id as errorId,description, level_log_id as levelLogId)) as errors,\n\t  main_error_id,\n  \t  status_id,\n\t  step_id\n  FROM Fil_not_InProgress\n  WHERE status_id = \"KO\"\n  GROUP BY trace_id, main_error_id, status_id, step_id\n)\n\n\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Jo_KO_DETAILED","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Every KO register with an errors array.","uiConfiguration":{"position":{"x":1997.179550030461,"y":293.5079948931957}},"configuration":{"sql":"SELECT DISTINCT\n\tSel_KO_Detailed.*, \n\tSel_Data.*\nFROM Sel_Data\nINNER JOIN Sel_KO_Detailed\nON Sel_KO_Detailed.traceId = Sel_Data.traceId\n","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[],"errorTableName":""},{"name":"Json_KO_DETAILED","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"description":"Creamos el JSON a enviar a GTS","uiConfiguration":{"position":{"x":2259.2594450499923,"y":293.5080254107738}},"configuration":{"sql":"select collect_list(struct(\n\t*\n)) AS customer\nfrom Jo_KO_DETAILED","discardConditions":"[]","inputSchemas":"[]","errorTableName":"","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]},{"name":"in_PG_process_log","stepType":"Input","className":"PostgresInputStepBatch","classPrettyName":"Postgres","arity":["NullaryToNary"],"description":"Input from process_log postgres","uiConfiguration":{"position":{"x":958.9906323065234,"y":126.52744302451094}},"configuration":{"inputOptions":"[]","url":"{{{Environment.POSTGRE_ASINC_MS_ONBOARDING}}}","debugOptions":"{\"query\":\"select\\n*\\n\\tfrom \\n\\t\\tGTS_ONETRADE.onboarding_pg_process_log\\nLIMIT 10\"}","isolationLevel":"READ_UNCOMMITTED","tlsEnabled":true,"caseSensitiveEnabled":true,"selectInput":"TABLE","dbtable":"onetradeonboardings.onboarding_process_log","errorTableName":""},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[],"outputsWriter":[]},{"name":"Fil_not_InProgress","stepType":"Transformation","className":"FilterTransformStep","classPrettyName":"Filter","arity":["UnaryToNary"],"uiConfiguration":{"position":{"x":1199.0012230858215,"y":120.4817616747811}},"configuration":{"filterExp":"status_id <> \"In_progress\"","inputSchemas":"[]","errorTableName":""},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[],"outputsWriter":[]}],"edges":[{"origin":"Json_OUT","destination":"Rep_OUT","dataType":"ValidData"},{"origin":"Rep_OUT","destination":"out_SFTP_jsonKOs","dataType":"ValidData"},{"origin":"Rep_OUT","destination":"out_JSON_JsonKOs","dataType":"ValidData"},{"origin":"in_JSON_onboarding","destination":"Expl_Identificadorlc","dataType":"ValidData"},{"origin":"Rep_QRKO","destination":"out_SFTP_jsonKOs","dataType":"ValidData"},{"origin":"Json_QRKO","destination":"Rep_QRKO","dataType":"ValidData"},{"origin":"Rep_QRKO","destination":"out_JSON_JsonKOs","dataType":"ValidData"},{"origin":"Rep_KO_Detailed","destination":"out_JSON_JsonKOs","dataType":"ValidData"},{"origin":"Rep_KO_Detailed","destination":"out_SFTP_jsonKOs","dataType":"ValidData"},{"origin":"Expl_Identificadorlc","destination":"Sel_Data","dataType":"ValidData"},{"origin":"Sel_Data","destination":"Jo_OUT","dataType":"ValidData"},{"origin":"Jo_OUT","destination":"Json_OUT","dataType":"ValidData"},{"origin":"Sel_Data","destination":"Jo_QRKO","dataType":"ValidData"},{"origin":"Sel_QRKO","destination":"Jo_QRKO","dataType":"ValidData"},{"origin":"Jo_QRKO","destination":"Json_QRKO","dataType":"ValidData"},{"origin":"Sel_KO_Detailed","destination":"Jo_KO_DETAILED","dataType":"ValidData"},{"origin":"Sel_Data","destination":"Jo_KO_DETAILED","dataType":"ValidData"},{"origin":"Jo_KO_DETAILED","destination":"Json_KO_DETAILED","dataType":"ValidData"},{"origin":"Json_KO_DETAILED","destination":"Rep_KO_Detailed","dataType":"ValidData"},{"origin":"in_PG_process_log","destination":"Fil_not_InProgress","dataType":"ValidData"},{"origin":"Fil_not_InProgress","destination":"Jo_OUT","dataType":"ValidData"},{"origin":"Fil_not_InProgress","destination":"Sel_QRKO","dataType":"ValidData"},{"origin":"Fil_not_InProgress","destination":"Sel_KO_Detailed","dataType":"ValidData"}],"annotations":[]},"executionEngine":"Batch","uiSettings":{"position":{"x":-508.0174165578052,"y":97.95043901768551,"k":0.5980122750618174}},"creationDate":"2020-02-03T08:41:42Z","lastUpdateDate":"2020-02-03T08:40:24Z","version":0,"group":{"id":"ab7361e4-761c-4883-afc8-b071f068f0dd","name":"/home/qa/onetrade-ot/onboarding-ob/raw/v1"},"debugMode":false,"versionSparta":"2.11.1-7a22d44","groupId":"ab7361e4-761c-4883-afc8-b071f068f0dd"}